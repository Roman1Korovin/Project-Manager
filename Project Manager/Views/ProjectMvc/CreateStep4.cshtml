@using Project_Manager.DTOs
@model Step4DTO

@{
    ViewData["Title"] = "Создание проекта - Шаг 4";
}

<h2>Создание проекта - Шаг 4/5</h2>

<form asp-action="CreateStep4" method="post">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <label class="form-label">Выберите сотрудников проекта</label>
        <select id="employeeSelect" class="form-select">
            <option value="">-- Выберите сотрудника --</option>
            @foreach (var employee in (List<EmployeeDTO>)ViewBag.Employees)
            {
                <option value="@employee.Id">@employee.FullName</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label>Выбранные сотрудники:</label>
        <ul id="selectedEmployees">
            @foreach (var id in Model.EmployeeIDs)
            {
                var emp = ((List<EmployeeDTO>)ViewBag.Employees).FirstOrDefault(e => e.Id == id);
                if (emp != null)
                {
                    <li data-id="@emp.Id">
                        @emp.FullName
                        <button type="button" class="btn btn-sm btn-danger remove-btn">x</button>
                        <input type="hidden" name="selectedEmployeeIds" value="@emp.Id" />
                    </li>
                }
            }
        </ul>
    </div>

    <button type="submit" class="btn btn-primary">Далее</button>
    <a asp-action="CreateStep3" class="btn btn-secondary">Назад</a>
</form>

@section Scripts {
    <script>
        const employeeSelect = document.getElementById("employeeSelect");
        const selectedEmployees = document.getElementById("selectedEmployees");

        function addRemoveListener(btn) {
            btn.addEventListener("click", () => {
                const li = btn.parentElement;
                li.remove();
            });
        }

        document.querySelectorAll(".remove-btn").forEach(addRemoveListener);

        employeeSelect.addEventListener("change", function () {
            const selectedId = this.value;
            const selectedText = this.options[this.selectedIndex].text;
            if (!selectedId) return;

            if ([...selectedEmployees.querySelectorAll("li")].some(li => li.dataset.id === selectedId)) return;

            const li = document.createElement("li");
            li.dataset.id = selectedId;
            li.textContent = selectedText + " ";

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn btn-sm btn-danger remove-btn";
            btn.textContent = "x";
            addRemoveListener(btn);

            li.appendChild(btn);

            const hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "selectedEmployeeIds";
            hiddenInput.value = selectedId;
            li.appendChild(hiddenInput);

            selectedEmployees.appendChild(li);

            this.value = "";
        });
    </script>
}